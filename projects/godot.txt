extends CharacterBody2D

signal life_changed(lives)
signal dead

# var body_textures={
# 	'head':'res://assets/sprites/cherry.png',
# 	'gem':'res://assets/sprites/gem.png'......
# }

var MOVE_SPEED = 10000

@onready var face_vector = Vector2.ZERO
@onready var face_left = true
@onready var animationTree = $AnimationTree
@onready var animationState = animationTree.get("parameters/playback")

@export var character_state = IDLE

# 人物属性
var healthMax = 100.0;
var healthCurrent = 100.0;
var healthRecovery = 0.0;
var healthRecoveryLockTime = 10.0;

var magicMax = 100.0;
var magicCurrent;
var magicRecovery = 10.0;
var magicRecoveryLockTime = 10.0;

var moveSpeed = 200;

var isAttack = false;
var isHurt = false;

var attack = 1.0;
var attackRange = 1.0;
var attackInterval = 0.6;
var attackSpeed = 1.0;

var magicAttack = 1.0;
var magicInterval = 1.0;
var magicSpeed = 1.0;
var magicCoolDownSpeed = 1.0;

var defense = 1.0;
var defensePCT = 1.0;
var hurtInterval = 0.65;

# 计算状态
# private int characterState = 1; // 1.idle, 2.move, 3.attack, 4.hit, 5.vanish 控制动画
# private int aniState = 1;
# private int weaponType = 1;

# 读取输入
# private Vector2 mouseDire = Vector2.down;
# private Vector2 movement;

# 获取物体
# private Camera cam;
# public GameObject playerWeapon;
# public GameObject playerCover;
# public TextMeshProUGUI healthText;
# public Image healthBar;

# private Rigidbody2D rb;
# private Transform transf;
# private Animator playerAni;
# private Animator playerWeaponAni;
# private Animator playerCoverAni;

enum{IDLE,MOVE,ATTACK,HURT,DIE}



#@onready var hurtbox = $Hurtbox


func get_vector_to_mouse():
	var character_position = get_position()
	var mouse_position = get_viewport().get_mouse_position()
	var local_mouse_position = get_tree().get_root().to_local(mouse_position)
	var vector_to_mouse = local_mouse_position - character_position
	return vector_to_mouse

func _ready() -> void:
	change_state_ani(IDLE,"Idle")
	animationTree.active = true

func _physics_process(delta):

	if character_state == IDLE or MOVE:
		check_item()
		check_attack()
		if character_state != ATTACK:
			check_move_idle(delta)

	change_face()

func check_item():
	pass

# 待完善
func check_attack():
	if Input.is_action_pressed("input_normal_attack"):
		change_state_ani(ATTACK,"Attack")
		physical_attack()
	elif  Input.is_action_pressed("input_special_attack"):
		change_state_ani(ATTACK,"Attack")
		physical_attack()
	elif Input.is_action_pressed("input_magic_attack"):
		change_state_ani(ATTACK,"Attack")
		magical_attack()
	elif Input.is_action_pressed("input_special_magic"):
		change_state_ani(ATTACK,"Attack")
		magical_attack()

func change_state_ani(new_state, new_ani):
	if new_state == character_state:
		return
	character_state= new_state
	var anitreeblend = "parameters/"+ new_ani +"/blend_position"
	animationTree.set(anitreeblend, face_vector)
	animationState.travel(new_ani)

func check_move_idle(delta):
	var move_vector = Input.get_vector("ui_left","ui_right","ui_up","ui_down")
	if move_vector != Vector2.ZERO:
		velocity = move_vector * MOVE_SPEED * delta
		face_vector = move_vector
		move_and_slide()
		change_state_ani(MOVE,"Walk")
	elif character_state == MOVE:
		change_state_ani(IDLE,"Idle")

func physical_attack(mode=1):
	pass

func magical_attack(mode=1):
	pass

func hurt(life):
	emit_signal('life_changed',life)

	# 击退
	# velocity.y=-200
	# velocity.x=-100*sign(velocity.x)
	life-=1
	emit_signal('life_changed',life)
	# await(get_tree().create_timer(.5),'timeout')
	# change_state(IDLE)
	if life<=0:
	#  	change_state(DEAD)
	# DEAD:
	# 	emit_signal('dead')
		hide()



	change_state_ani(HURT,"Hurt")

func hurt_interval_waiter():
	pass
	# yield(get_tree().create_timer(hurtInterval), "timeout")

func change_face():
	if face_vector.x < 0 and not face_left:
		scale.x = -scale.x
		face_left = true
	elif face_vector.x > 0 and face_left:
		scale.x = -scale.x
		face_left = false

#func _on_Hurtbox_area_entered(area):
#	stats.health -= area.damage
#	hurtbox.start_invincibility(0.6)
#	hurtbox.create_hit_effect()
#	var playerHurtSound = PlayerHurtSound.instance()
#	get_tree().current_scene.add_child(playerHurtSound)


# updatemouseDire() idle 状态，根据鼠标方向调整位置
# updateWeaponType（）idle 状态，获取input
